<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICE Activity Monitor - Complete Dataset Analysis</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root {
            /* Ice-themed palette - cool, alert, but less harsh */
            --ice-blue: #5B9BD5;
            --frost-white: #E8F4F8;
            --steel-gray: #4A5568;
            --midnight-blue: #2C3E50;
            --alert-coral: #FF6B6B;
            --warning-amber: #FFA726;
            --safe-teal: #26A69A;
            --slate: #34495E;
            
            /* Functional color mapping */
            --warning-red: #FF6B6B;
            --alert-orange: #FFA726;
            --safe-green: #26A69A;
            --bg-dark: #1E2936;
            --bg-card: #2C3E50;
            --text-primary: #E8F4F8;
            --text-secondary: #94A3B8;
            --border-color: rgba(91, 155, 213, 0.2);
            --accent-primary: #5B9BD5;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 2rem;
        }

        .alert-banner {
            background: linear-gradient(135deg, rgba(91, 155, 213, 0.15), rgba(44, 62, 80, 0.15));
            border: 2px solid var(--accent-primary);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .alert-banner .icon { font-size: 1.5rem; }
        .alert-banner .text { flex: 1; font-size: 0.9rem; line-height: 1.5; }
        .alert-banner .text strong { color: var(--accent-primary); }
        .alert-banner a { color: var(--accent-primary); text-decoration: underline; font-weight: 600; }

        .disclaimer {
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.1), rgba(255, 167, 38, 0.08));
            border: 2px solid var(--warning-red);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            font-size: 0.85rem;
            line-height: 1.6;
        }

        .disclaimer h3 {
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            color: var(--warning-red);
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .disclaimer p { margin-bottom: 0.5rem; color: var(--text-secondary); }
        .disclaimer strong { color: var(--text-primary); }

        header {
            margin-bottom: 3rem;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 2rem;
        }

        h1 {
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            font-size: 3.5rem;
            margin-bottom: 0.5rem;
            letter-spacing: 1px;
            background: linear-gradient(135deg, var(--ice-blue), var(--midnight-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            color: var(--text-secondary);
            font-weight: 300;
        }

        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(91, 155, 213, 0.15);
            border: 1px solid var(--accent-primary);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            margin-top: 1rem;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .pulse-dot {
            width: 8px;
            height: 8px;
            background: var(--accent-primary);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            transition: transform 0.2s, border-color 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            border-color: var(--accent-primary);
            box-shadow: 0 4px 12px rgba(91, 155, 213, 0.3);
        }

        .stat-label {
            font-family: 'Poppins', sans-serif;
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .stat-value {
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            font-size: 2.5rem;
            color: var(--text-primary);
        }

        .insight-section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .section-title {
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            letter-spacing: 1px;
        }

        .section-subtitle {
            font-family: 'Poppins', sans-serif;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
            font-weight: 300;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .loading-progress {
            font-size: 0.9rem;
            margin-top: 1rem;
            color: var(--accent-primary);
        }

        .error {
            background: rgba(255, 107, 107, 0.1);
            border: 2px solid var(--warning-red);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            color: var(--warning-red);
        }

        .refresh-btn {
            background: var(--accent-primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s;
            margin-bottom: 2rem;
            letter-spacing: 0.5px;
        }

        .refresh-btn:hover {
            background: #4A8BC2;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(91, 155, 213, 0.4);
        }

        .refresh-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .pattern-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .pattern-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
        }

        .pattern-icon { font-size: 2rem; margin-bottom: 0.5rem; }

        .pattern-title {
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            letter-spacing: 0.5px;
        }

        .pattern-description {
            font-family: 'Poppins', sans-serif;
            font-size: 0.9rem;
            line-height: 1.6;
            color: var(--text-secondary);
            font-weight: 300;
        }

        .pattern-highlight { color: var(--warning-red); font-weight: 600; }
        .pattern-safe { color: var(--safe-teal); font-weight: 600; }

        @media (max-width: 768px) {
            body { padding: 1rem; }
            h1 { font-size: 2rem; }
            .stats-grid { grid-template-columns: 1fr; }
            .pattern-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="alert-banner">
        <div class="icon">‚è±Ô∏è</div>
        <div class="text">
            <strong>24-Hour Data Lag:</strong> This dashboard shows historical patterns. For <strong>real-time ICE incidents and reports</strong>, visit <a href="https://iceout.org/en" target="_blank">iceout.org/en</a>
        </div>
    </div>

    <div class="disclaimer">
        <h3>‚ö†Ô∏è Important Legal Disclaimer</h3>
        <p><strong>FOR INFORMATIONAL AND EDUCATIONAL PURPOSES ONLY.</strong> This dashboard displays community-reported data and is provided "as-is" without any warranties or guarantees of accuracy, completeness, or reliability.</p>
        <p><strong>NOT FOR SAFETY DECISIONS:</strong> This information should NOT be used as the sole basis for any safety, legal, or personal decisions. Data may be incomplete, outdated, or inaccurate.</p>
        <p><strong>NO LIABILITY:</strong> The creator(s) of this dashboard assume no responsibility or liability for any actions taken based on this information, including but not limited to personal injury, property damage, or legal consequences.</p>
        <p><strong>USE AT YOUR OWN RISK:</strong> By viewing this dashboard, you acknowledge that you use this information entirely at your own risk and agree to indemnify and hold harmless the creator(s) from any claims arising from your use of this data.</p>
    </div>

    <header>
        <h1>ICE Activity Monitor</h1>
        <p class="subtitle">Complete Historical Dataset Analysis - Minneapolis/St. Paul</p>
        <div class="live-indicator">
            <div class="pulse-dot"></div>
            <span>LIVE DATA</span>
        </div>
    </header>

    <button class="refresh-btn" onclick="loadAllData()" id="refreshBtn">‚Üª Refresh Data</button>

    <div id="loadingArea" class="loading">
        <div>Loading complete dataset with pagination...</div>
        <div class="loading-progress" id="loadingProgress"></div>
    </div>

    <div id="dashboardContent" style="display: none;">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Incidents Analyzed</div>
                <div class="stat-value" id="totalIncidents">‚Äî</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Most Recent Incident</div>
                <div class="stat-value" id="mostRecent" style="font-size: 1.3rem;">‚Äî</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Most Active City</div>
                <div class="stat-value" id="mostActiveCity" style="font-size: 1.6rem;">‚Äî</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Peak Activity Hour</div>
                <div class="stat-value" id="peakHour" style="font-size: 1.8rem;">‚Äî</div>
            </div>
        </div>

        <div class="insight-section">
            <h2 class="section-title">üìÖ ICE Activity by Day of Week</h2>
            <p class="section-subtitle">Total incidents across entire dataset</p>
            <canvas id="dayChart"></canvas>
        </div>

        <div class="insight-section">
            <h2 class="section-title">üïê ICE Activity by Hour of Day (24-hour clock)</h2>
            <p class="section-subtitle">Total incidents per hour across complete dataset</p>
            <canvas id="hourChart"></canvas>
        </div>

        <div class="insight-section">
            <h2 class="section-title">üìä Activity Over Time (Last 60 Days)</h2>
            <p class="section-subtitle">Daily incident trend</p>
            <canvas id="timelineChart"></canvas>
        </div>

        <div class="insight-section">
            <h2 class="section-title">üìç High-Risk Locations</h2>
            <p class="section-subtitle">Areas with highest activity</p>
            <div id="hotLocations" class="pattern-grid"></div>
        </div>

        <div class="insight-section">
            <h2 class="section-title">üîç Key Patterns for Community Safety</h2>
            <div id="patternInsights" class="pattern-grid"></div>
        </div>

        <!-- Self-Care & Support -->
        <div class="insight-section" style="border: 2px solid var(--safe-teal); background: rgba(38, 166, 154, 0.05);">
            <h2 class="section-title">üíö You Are Not Alone</h2>
            <p style="font-size: 1rem; line-height: 1.8; margin-bottom: 1.5rem; color: var(--text-primary);">
                It's completely normal to feel overwhelmed, scared, or anxious about ICE activity. This is a horrifying situation, and your feelings are valid. Please remember: <strong style="color: var(--safe-teal);">you are part of a strong community, and we protect each other.</strong>
            </p>
            <div style="background: rgba(255, 255, 255, 0.03); padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--safe-teal); margin-bottom: 1.5rem;">
                <div style="font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 1.1rem; margin-bottom: 0.75rem; color: var(--text-primary);">If You're Struggling:</div>
                <div style="line-height: 1.8; color: var(--text-secondary);">
                    <strong style="color: var(--text-primary);">Crisis Text Line:</strong> Text HOME to <span style="color: var(--safe-teal); font-weight: 600;">741741</span><br>
                    <strong style="color: var(--text-primary);">SAMHSA National Helpline:</strong> <span style="color: var(--safe-teal); font-weight: 600;">1-800-662-4357</span> (free, confidential, 24/7)<br>
                    <br>
                    <em>Take breaks from the news. Rest when you need to. Ask friends for support. Your mental health matters.</em>
                </div>
            </div>
        </div>

        <!-- Know Your Rights -->
        <div class="insight-section" style="border: 2px solid var(--accent-primary); background: rgba(91, 155, 213, 0.05);">
            <h2 class="section-title">üìã Know Your Rights: Quick Guide</h2>
            <p class="section-subtitle">Legal protections you have during an ICE encounter - memorize these</p>
            <div style="display: grid; gap: 1rem; margin-top: 1rem;">
                <div style="background: rgba(255, 255, 255, 0.03); padding: 1.25rem; border-radius: 8px; border-left: 4px solid var(--accent-primary);">
                    <div style="font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 1.1rem; margin-bottom: 0.5rem; color: var(--text-primary);">üö™ At Your Door</div>
                    <div style="line-height: 1.7; color: var(--text-secondary);">
                        <strong style="color: var(--text-primary);">DO NOT open the door.</strong> Ask them to slip any warrant under the door or through a window. A warrant must be signed by a judge and list your exact name and address. An "administrative warrant" or "deportation warrant" is NOT enough to enter your home.
                    </div>
                </div>
                <div style="background: rgba(255, 255, 255, 0.03); padding: 1.25rem; border-radius: 8px; border-left: 4px solid var(--accent-primary);">
                    <div style="font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 1.1rem; margin-bottom: 0.5rem; color: var(--text-primary);">ü§ê Right to Remain Silent</div>
                    <div style="line-height: 1.7; color: var(--text-secondary);">
                        Say clearly: <strong style="color: var(--safe-teal);">"I am exercising my right to remain silent. I do not consent to any searches."</strong> Then STOP TALKING. You do not have to answer questions about your citizenship, where you were born, or how you entered the country.
                    </div>
                </div>
                <div style="background: rgba(255, 255, 255, 0.03); padding: 1.25rem; border-radius: 8px; border-left: 4px solid var(--accent-primary);">
                    <div style="font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 1.1rem; margin-bottom: 0.5rem; color: var(--text-primary);">‚öñÔ∏è Right to a Lawyer</div>
                    <div style="line-height: 1.7; color: var(--text-secondary);">
                        Say: <strong style="color: var(--safe-teal);">"I want to speak to a lawyer."</strong> Do NOT sign anything without talking to a lawyer first. You have the right to a phone call. Carry a "know your rights" card with a lawyer's number.
                    </div>
                </div>
                <div style="background: rgba(255, 255, 255, 0.03); padding: 1.25rem; border-radius: 8px; border-left: 4px solid var(--accent-primary);">
                    <div style="font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 1.1rem; margin-bottom: 0.5rem; color: var(--text-primary);">üö´ What NOT to Do</div>
                    <div style="line-height: 1.7; color: var(--text-secondary);">
                        ‚Ä¢ Don't lie (but you can stay silent)<br>
                        ‚Ä¢ Don't show fake documents<br>
                        ‚Ä¢ Don't run away<br>
                        ‚Ä¢ Don't physically resist arrest<br>
                        ‚Ä¢ Don't sign anything you don't understand
                    </div>
                </div>
            </div>
        </div>

        <!-- Resistance Tactics -->
        <div class="insight-section" style="border: 2px solid var(--warning-amber);">
            <h2 class="section-title">‚úä Community Defense Ideas</h2>
            <p class="section-subtitle" style="color: var(--warning-amber); font-weight: 600;">‚ö†Ô∏è FOR INFORMATIONAL AND ENTERTAINMENT PURPOSES ONLY - Not legal advice. Understand risks before taking action.</p>
            <p style="font-size: 0.9rem; line-height: 1.6; margin-bottom: 1.5rem; color: var(--text-secondary);">
                These are historical tactics communities have used. <strong>Any action carries legal risk.</strong> Make your own informed decisions about what level of involvement feels right for you.
            </p>
            <div class="pattern-grid">
                <div class="pattern-card" style="border-left: 3px solid var(--warning-amber);">
                    <div class="pattern-icon">üì¢</div>
                    <div class="pattern-title">Make Noise</div>
                    <div class="pattern-description">
                        <strong>Blow whistles, honk horns, bang pots.</strong> Loud noise alerts neighbors and attracts public attention. ICE often retreats when operations become highly visible. <em>Legal risk: Low</em>
                    </div>
                </div>

                <div class="pattern-card" style="border-left: 3px solid var(--solar-ember);">
                    <div class="pattern-icon">üì±</div>
                    <div class="pattern-title">Document & Witness</div>
                    <div class="pattern-description">
                        <strong>Record from a safe distance.</strong> Film badge numbers, vehicle plates, timing. Stay on public property. Share with legal observers. <em>Legal risk: Low if you maintain safe distance</em>
                    </div>
                </div>

                <div class="pattern-card" style="border-left: 3px solid var(--solar-ember);">
                    <div class="pattern-icon">üë•</div>
                    <div class="pattern-title">Community Presence</div>
                    <div class="pattern-description">
                        <strong>Gather peacefully in public spaces.</strong> Large groups of witnesses often deter operations. Stand on sidewalks, observe from distance. <em>Legal risk: Low if nonviolent and on public property</em>
                    </div>
                </div>

                <div class="pattern-card" style="border-left: 3px solid var(--solar-ember);">
                    <div class="pattern-icon">üîî</div>
                    <div class="pattern-title">Rapid Alerts</div>
                    <div class="pattern-description">
                        <strong>Text chains, Signal groups, phone trees.</strong> Immediate information sharing: location, vehicle description, agent count. Fast community response. <em>Legal risk: None</em>
                    </div>
                </div>

                <div class="pattern-card" style="border-left: 3px solid var(--solar-ember);">
                    <div class="pattern-icon">‚è±Ô∏è</div>
                    <div class="pattern-title">Ask Questions</div>
                    <div class="pattern-description">
                        <strong>Request identification, ask for supervisor, ask about warrants.</strong> You have the right to understand what's happening. Document responses. <em>Legal risk: None - this is your right</em>
                    </div>
                </div>

                <div class="pattern-card" style="border-left: 3px solid var(--solar-ember);">
                    <div class="pattern-icon">üõ°Ô∏è</div>
                    <div class="pattern-title">Know & Share Rights</div>
                    <div class="pattern-description">
                        <strong>Carry "know your rights" cards. Share them.</strong> Inform others they can refuse to answer questions, don't have to open doors, can request lawyers. <em>Legal risk: None</em>
                    </div>
                </div>

                <div class="pattern-card" style="border-left: 3px solid var(--solar-ember);">
                    <div class="pattern-icon">üö∂</div>
                    <div class="pattern-title">Legal Observation</div>
                    <div class="pattern-description">
                        <strong>Stand as legal observers.</strong> Wear identification, take notes, document procedures. Legal observer networks provide accountability. <em>Legal risk: Low</em>
                    </div>
                </div>

                <div class="pattern-card" style="border-left: 3px solid var(--solar-ember);">
                    <div class="pattern-icon">ü§ù</div>
                    <div class="pattern-title">Accompany & Support</div>
                    <div class="pattern-description">
                        <strong>Walk with vulnerable community members.</strong> Accompany people to appointments, transit, work. Physical presence of allies can deter targeting. <em>Legal risk: None</em>
                    </div>
                </div>

                <div class="pattern-card" style="border-left: 3px solid var(--warning-amber); grid-column: 1 / -1;">
                    <div class="pattern-icon">‚ö°</div>
                    <div class="pattern-title">Important: Understand Your Risks</div>
                    <div class="pattern-description">
                        Some communities have <strong style="color: var(--safe-teal);">successfully used these tactics</strong> to prevent deportations. However, <strong style="color: var(--warning-red);">any direct action carries potential legal consequences.</strong> Do not physically obstruct federal agents, do not lie to law enforcement, do not provide false information. Research your local laws, consult with lawyers, and make informed decisions about your own level of involvement.
                    </div>
                </div>
            </div>
        </div>

        <!-- Community Resources -->
        <div class="insight-section" style="border: 2px solid var(--accent-primary);">
            <h2 class="section-title">ü§ù Community Resources & Support</h2>
            <p class="section-subtitle">Know your rights and support mutual aid efforts</p>
            <div style="display: grid; gap: 1.5rem; margin-top: 1.5rem;">
                <a href="https://immigrantjustice.org/for-immigrants/know-your-rights/ice-encounter/" target="_blank" style="display: flex; align-items: center; gap: 1rem; background: rgba(255, 255, 255, 0.03); padding: 1.5rem; border-radius: 8px; border: 1px solid var(--border-color); text-decoration: none; color: var(--text-primary); transition: all 0.2s;">
                    <div style="font-size: 2rem;">üìö</div>
                    <div style="flex: 1;">
                        <div style="font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 1.2rem; margin-bottom: 0.25rem;">Know Your Rights</div>
                        <div style="font-family: 'Poppins', sans-serif; font-size: 0.9rem; color: var(--text-secondary);">Essential legal information if you encounter ICE</div>
                    </div>
                    <div style="color: var(--accent-primary); font-size: 1.5rem;">‚Üí</div>
                </a>
                <a href="https://docs.proton.me/doc?mode=open-url&token=3BQTG29B88#46R7ocgiFwew" target="_blank" style="display: flex; align-items: center; gap: 1rem; background: rgba(255, 255, 255, 0.03); padding: 1.5rem; border-radius: 8px; border: 1px solid var(--border-color); text-decoration: none; color: var(--text-primary); transition: all 0.2s;">
                    <div style="font-size: 2rem;">üìã</div>
                    <div style="flex: 1;">
                        <div style="font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 1.2rem; margin-bottom: 0.25rem;">Local Resources</div>
                        <div style="font-family: 'Poppins', sans-serif; font-size: 0.9rem; color: var(--text-secondary);">Community safety guides and local support</div>
                    </div>
                    <div style="color: var(--accent-primary); font-size: 1.5rem;">‚Üí</div>
                </a>
                <a href="https://linktr.ee/mplsmutualaid" target="_blank" style="display: flex; align-items: center; gap: 1rem; background: rgba(91, 155, 213, 0.1); padding: 1.5rem; border-radius: 8px; border: 1px solid var(--accent-primary); text-decoration: none; color: var(--text-primary); transition: all 0.2s;">
                    <div style="font-size: 2rem;">‚ù§Ô∏è</div>
                    <div style="flex: 1;">
                        <div style="font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 1.2rem; margin-bottom: 0.25rem;">Support Mutual Aid</div>
                        <div style="font-family: 'Poppins', sans-serif; font-size: 0.9rem; color: var(--text-secondary);">Donate to support community protection and rapid response</div>
                    </div>
                    <div style="color: var(--accent-primary); font-size: 1.5rem;">‚Üí</div>
                </a>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            apiKey: 'pat4Wu1xZwnJjLXpU.95d481c0aa858c4c730cbd8b4933dd0d8c7045f636b7180310e06f29bee6162e',
            baseId: 'app8mH6QAlAxuuygZ',
            tableId: 'tblsqeROfxhPiGWfH'
        };

        let dayChart, hourChart, timelineChart;

        async function loadAllData() {
            const loadingArea = document.getElementById('loadingArea');
            const dashboardContent = document.getElementById('dashboardContent');
            const refreshBtn = document.getElementById('refreshBtn');
            const loadingProgress = document.getElementById('loadingProgress');
            
            refreshBtn.disabled = true;
            refreshBtn.textContent = '‚è≥ Loading Complete Dataset...';
            loadingArea.style.display = 'block';
            dashboardContent.style.display = 'none';

            try {
                let allRecords = [];
                let offset = null;
                let pageCount = 0;

                do {
                    pageCount++;
                    const url = `https://api.airtable.com/v0/${CONFIG.baseId}/${CONFIG.tableId}${offset ? `?offset=${offset}` : ''}`;
                    
                    loadingProgress.textContent = `Loading page ${pageCount}... (${allRecords.length} records so far)`;
                    
                    console.log(`Fetching page ${pageCount}:`, url);

                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${CONFIG.apiKey}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status}`);
                    }

                    const data = await response.json();
                    allRecords = allRecords.concat(data.records);
                    offset = data.offset;
                    
                    console.log(`Page ${pageCount}: Got ${data.records.length} records. Offset: ${offset || 'none (last page)'}`);
                    
                } while (offset);

                console.log('‚úì COMPLETE! Loaded', allRecords.length, 'total records');
                
                if (allRecords.length === 0) {
                    throw new Error('No records found');
                }

                loadingArea.style.display = 'none';
                dashboardContent.style.display = 'block';
                
                analyzeCompleteDataset(allRecords);
                
            } catch (error) {
                console.error('Error:', error);
                loadingArea.innerHTML = `
                    <div class="error">
                        <h3>Error Loading Data</h3>
                        <p>${error.message}</p>
                        <p style="margin-top: 1rem;">Check browser console (F12) for details</p>
                    </div>
                `;
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.textContent = '‚Üª Refresh Data';
            }
        }

        function analyzeCompleteDataset(records) {
            console.log('=== ANALYZING COMPLETE DATASET ===');
            console.log('Total records:', records.length);
            
            updateStats(records);
            createDayChart(records);
            createHourChart(records);
            createTimelineChart(records);
            createHotLocations(records);
            createPatternInsights(records);
            
            console.log('‚úì Analysis complete');
        }

        function updateStats(records) {
            document.getElementById('totalIncidents').textContent = records.length.toLocaleString();

            const dates = records.map(r => new Date(r.fields.activity_date)).filter(d => !isNaN(d));
            if (dates.length > 0) {
                const maxDate = new Date(Math.max(...dates));
                const daysSince = Math.floor((new Date() - maxDate) / (1000 * 60 * 60 * 24));
                const freshness = daysSince === 0 ? 'Today' : daysSince === 1 ? 'Yesterday' : `${daysSince} days ago`;
                document.getElementById('mostRecent').textContent = maxDate.toLocaleDateString('en-US', {month: 'short', day: 'numeric'});
                document.getElementById('mostRecent').title = `${freshness} - Data is ${daysSince} days old`;
            }

            const cityCounts = {};
            records.forEach(r => {
                if (r.fields.city) cityCounts[r.fields.city] = (cityCounts[r.fields.city] || 0) + 1;
            });
            const sortedCities = Object.entries(cityCounts).sort((a, b) => b[1] - a[1]);
            if (sortedCities.length > 0) {
                document.getElementById('mostActiveCity').textContent = sortedCities[0][0];
            }

            const hourCounts = {};
            records.forEach(r => {
                const hour = r.fields.hour_of_day;
                if (hour !== undefined && hour !== null) {
                    hourCounts[hour] = (hourCounts[hour] || 0) + 1;
                }
            });

            const sortedHours = Object.entries(hourCounts).sort((a, b) => b[1] - a[1]);
            if (sortedHours.length > 0) {
                document.getElementById('peakHour').textContent = formatHour(parseInt(sortedHours[0][0]));
            }
        }

        function formatHour(hour) {
            if (hour === 0) return '12 AM';
            if (hour < 12) return `${hour} AM`;
            if (hour === 12) return '12 PM';
            return `${hour - 12} PM`;
        }

        function createDayChart(records) {
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            const dayCounts = {};
            
            days.forEach(day => dayCounts[day] = 0);
            
            // Count incidents by day of week
            records.forEach(r => {
                const dateStr = r.fields.activity_date;
                if (dateStr) {
                    // Parse date string as UTC to avoid timezone shifting
                    // Assuming format is YYYY-MM-DD
                    const parts = dateStr.split('-');
                    if (parts.length === 3) {
                        const year = parseInt(parts[0]);
                        const month = parseInt(parts[1]) - 1; // JS months are 0-indexed
                        const day = parseInt(parts[2]);
                        const date = new Date(year, month, day);
                        
                        if (!isNaN(date.getTime())) {
                            const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });
                            if (dayCounts[dayName] !== undefined) {
                                dayCounts[dayName]++;
                            }
                        }
                    }
                }
            });

            const counts = days.map(d => dayCounts[d]);
            const maxCount = Math.max(...counts);

            console.log('Day of week counts:', dayCounts);
            console.log('Sample dates processed:', records.slice(0, 5).map(r => ({
                date: r.fields.activity_date,
                parsed_day: (() => {
                    const dateStr = r.fields.activity_date;
                    if (dateStr) {
                        const parts = dateStr.split('-');
                        if (parts.length === 3) {
                            const date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                            return date.toLocaleDateString('en-US', { weekday: 'long' });
                        }
                    }
                    return 'invalid';
                })()
            })));

            const ctx = document.getElementById('dayChart');
            if (dayChart) dayChart.destroy();
            
            dayChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: days,
                    datasets: [{
                        label: 'Incidents',
                        data: counts,
                        backgroundColor: counts.map(c => c === maxCount ? 'rgba(255, 107, 107, 0.9)' : 'rgba(91, 155, 213, 0.7)'),
                        borderColor: 'rgba(91, 155, 213, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.9)',
                            callbacks: {
                                label: (ctx) => `${ctx.parsed.y} incidents`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#B4B6BA' },
                            grid: { color: 'rgba(180, 182, 186, 0.1)' },
                            title: { display: true, text: 'Number of Incidents', color: '#B4B6BA' }
                        },
                        x: {
                            ticks: { color: '#B4B6BA' },
                            grid: { display: false },
                            title: { display: true, text: 'Day', color: '#B4B6BA' }
                        }
                    }
                }
            });
        }

        function createHourChart(records) {
            const hourCounts = Array(24).fill(0);
            
            records.forEach(r => {
                const hour = r.fields.hour_of_day;
                if (hour !== undefined && hour !== null && hour >= 0 && hour < 24) {
                    hourCounts[hour]++;
                }
            });

            const maxCount = Math.max(...hourCounts);

            console.log('Hour counts:', hourCounts);
            console.log('Peak hour count:', maxCount);

            const ctx = document.getElementById('hourChart');
            if (hourChart) hourChart.destroy();
            
            hourChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Array.from({length: 24}, (_, i) => i),
                    datasets: [{
                        label: 'Incidents',
                        data: hourCounts,
                        backgroundColor: hourCounts.map(count => {
                            if (count === 0) return 'rgba(38, 166, 154, 0.8)';
                            if (count === maxCount) return 'rgba(255, 107, 107, 0.9)';
                            return 'rgba(91, 155, 213, 0.7)';
                        }),
                        borderColor: 'rgba(91, 155, 213, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.9)',
                            callbacks: {
                                title: (items) => `${items[0].label}:00 (${formatHour(parseInt(items[0].label))})`,
                                label: (ctx) => `${ctx.parsed.y} incidents`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#B4B6BA' },
                            grid: { color: 'rgba(180, 182, 186, 0.1)' },
                            title: { display: true, text: 'Number of Incidents', color: '#B4B6BA' }
                        },
                        x: {
                            ticks: { color: '#B4B6BA' },
                            grid: { display: false },
                            title: { display: true, text: 'Hour (0 = midnight, 12 = noon)', color: '#B4B6BA' }
                        }
                    }
                }
            });
        }

        function createTimelineChart(records) {
            const sixtyDaysAgo = new Date();
            sixtyDaysAgo.setDate(sixtyDaysAgo.getDate() - 60);
            
            const recentRecords = records.filter(r => {
                const date = new Date(r.fields.activity_date);
                return !isNaN(date) && date >= sixtyDaysAgo;
            });

            const dateCounts = {};
            recentRecords.forEach(r => {
                const dateStr = r.fields.activity_date;
                if (dateStr) dateCounts[dateStr] = (dateCounts[dateStr] || 0) + 1;
            });

            const sortedDates = Object.keys(dateCounts).sort();
            const counts = sortedDates.map(d => dateCounts[d]);

            const ctx = document.getElementById('timelineChart');
            if (timelineChart) timelineChart.destroy();
            
            timelineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedDates.map(d => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
                    datasets: [{
                        label: 'Daily Incidents',
                        data: counts,
                        borderColor: 'rgba(91, 155, 213, 1)',
                        backgroundColor: 'rgba(91, 155, 213, 0.2)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#B4B6BA' }, grid: { color: 'rgba(180, 182, 186, 0.1)' } },
                        x: { ticks: { color: '#B4B6BA', maxRotation: 45 }, grid: { display: false } }
                    }
                }
            });
        }

        function createHotLocations(records) {
            const cityCounts = {};
            records.forEach(r => {
                if (r.fields.city) cityCounts[r.fields.city] = (cityCounts[r.fields.city] || 0) + 1;
            });
            
            const topCities = Object.entries(cityCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);
            
            document.getElementById('hotLocations').innerHTML = topCities.map(([city, count]) => `
                <div class="pattern-card" style="border-left: 3px solid var(--accent-primary);">
                    <div class="pattern-icon">üèôÔ∏è</div>
                    <div class="pattern-title">${city}</div>
                    <div class="pattern-description">
                        <span class="pattern-highlight">${count} incidents</span> (${((count/records.length)*100).toFixed(1)}% of all activity)
                    </div>
                </div>
            `).join('');
        }

        function createPatternInsights(records) {
            const hourCounts = {};
            records.forEach(r => {
                const hour = r.fields.hour_of_day;
                if (hour !== undefined) hourCounts[hour] = (hourCounts[hour] || 0) + 1;
            });

            const sortedHours = Object.entries(hourCounts).sort((a, b) => b[1] - a[1]);
            const peakHour = sortedHours[0];
            
            const allHours = Array.from({length: 24}, (_, i) => i);
            const hoursWithZero = allHours.filter(h => !hourCounts[h]);

            const abductions = records.filter(r => 
                r.fields.simplified_activity && r.fields.simplified_activity.toLowerCase().includes('abduction')
            );

            let safeHoursText = '';
            if (hoursWithZero.length > 0) {
                const hoursFormatted = hoursWithZero.map(h => formatHour(h));
                if (hoursWithZero.length === 1) {
                    safeHoursText = `<span class="pattern-safe">${hoursFormatted[0]} has ZERO incidents</span> - the statistically safest hour`;
                } else {
                    safeHoursText = `<span class="pattern-safe">${hoursWithZero.length} hours with ZERO incidents:</span> ${hoursFormatted.join(', ')} - the statistically safest times`;
                }
            } else {
                const safestHours = sortedHours.slice(-3);
                safeHoursText = `Lowest activity: ${safestHours.map(h => formatHour(parseInt(h[0]))).join(', ')}`;
            }

            const patterns = [
                {
                    icon: '‚ö†Ô∏è',
                    title: 'Peak Activity Hour',
                    description: `Most active at <span class="pattern-highlight">${formatHour(parseInt(peakHour[0]))}</span> with ${peakHour[1]} incidents across entire dataset`
                },
                {
                    icon: '‚úÖ',
                    title: hoursWithZero.length > 0 ? 'Zero-Activity Hours' : 'Safest Hours',
                    description: safeHoursText
                },
                {
                    icon: 'üö®',
                    title: 'Abduction Rate',
                    description: `${abductions.length} abductions (<span class="pattern-highlight">${(abductions.length/records.length*100).toFixed(1)}%</span>) across all data`
                },
                {
                    icon: 'üë•',
                    title: 'Community Defense Works',
                    description: `<span class="pattern-safe">Rapid response networks prevent detentions.</span> <a href="https://crimethinc.com/2025/12/03/when-the-feds-come-to-your-city-standing-up-to-ice-a-guide-from-chicago-organizers" target="_blank" style="color: var(--accent-primary); text-decoration: underline;">Read the guide from Chicago organizers ‚Üí</a>`
                }
            ];

            document.getElementById('patternInsights').innerHTML = patterns.map(p => `
                <div class="pattern-card">
                    <div class="pattern-icon">${p.icon}</div>
                    <div class="pattern-title">${p.title}</div>
                    <div class="pattern-description">${p.description}</div>
                </div>
            `).join('');
        }

        window.addEventListener('load', loadAllData);
    </script>
</body>
</html>
